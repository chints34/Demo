

		C0 BIT P3.0
		C1 BIT P3.1
		C2 BIT P3.2
	
		RW0 BIT P3.4
		RW1 BIT P3.5
		RW2 BIT P3.6

key segment code
rseg key

KROW1:DB 40h,79h,24h
KROW2:DB 30h,19h,12h
KROW3:DB 02h,78h,00h


  

T0_INT_VECT EQU 000BH

T1RA_LB EQU 00H 
T1RA_HB EQU 01H

T2RA_LB EQU 02H 
T2RA_HB EQU 03H

T3RA_LB EQU 04H 
T3RA_HB EQU 05H

CSEG AT 0
SJMP SCHEDULAR


CSEG AT T0_INT_VECT
CLR TR0

JB B.0,_TASK2
JB B.1,_TASK3
JB B.2,_TASK1

_TASK1:
POP T3RA_HB
POP T3RA_LB

PUSH T1RA_LB
PUSH T1RA_HB

MOV B,#1
SJMP RST_SCHEDULAR


_TASK2:
POP T1RA_HB
POP T1RA_LB

PUSH T2RA_LB
PUSH T2RA_HB

MOV B,#2
SJMP RST_SCHEDULAR



_TASK3:
POP T2RA_HB
POP T2RA_LB

PUSH T3RA_LB
PUSH T3RA_HB

MOV B,#4
SJMP RST_SCHEDULAR


RST_SCHEDULAR:

	MOV TH0,#0D8H
	MOV TL0,#0F0H
	SETB TR0
	RETI


MAIN:

SCHEDULAR:

	MOV DPTR,#TASK1
	MOV T1RA_LB,DPL
	MOV T1RA_HB,DPH

	MOV DPTR,#TASK2

	MOV T2RA_LB,DPL
	MOV T2RA_HB,DPH

	MOV DPTR,#TASK3
	MOV T3RA_LB,DPL
	MOV T3RA_HB,DPH

	
	SETB EA
	SETB ET0
	MOV TMOD,#01H

	MOV TH0,#0D8H
	MOV TL0,#0F0H
	SETB TR0
	MOV B,#1

TASK1:
TASK1_LOOP:
	inc 30h
	MOV P2,#00H
	ACALL delay100ms
	MOV P2,#0FFH
	Sjmp TASK1_LOOP

TASK2:
	TASK2_LOOP:
		INC 31H

		CLR RW0
		CLR RW1
		CLR RW2                                                                                 
		SETB C0
		SETB C1
		SETB C2
		
		A1:
		ACALL COLCHECK
		JC A1

	SCAN1:
	;FOR ROW1
		CLR RW0
		SETB RW1
		SETB RW2
		ACALL COLCHECK
		JC ROW1
		SJMP DISP1

		ROW1:
	;FOR ROW2
		SETB RW0
		CLR RW1
		SETB RW2
		ACALL COLCHECK
		JC ROW2
		SJMP DISP2


		ROW2:
	;FOR ROW3
		SETB RW0
		SETB RW1
		CLR RW2
		ACALL COLCHECK
		SJMP DISP3
DISP1:
	MOV DPTR,#KROW1
	SJMP COLSCAN
	

DISP2:
	MOV DPTR,#KROW2
	SJMP COLSCAN

DISP3:
	MOV DPTR,#KROW3
	SJMP COLSCAN

COLSCAN:
   		MOV R3,#0
		JNB C0,DIS
		INC R3
		JNB C1,DIS
		INC R3
		JNB C2,DIS
DIS:
	MOV A,R3
	MOVC A,@A+DPTR
	MOV 20H,A

SJMP TASK2_LOOP

TASK3:
	TASK3_LOOP:
		INC 32H
		MOV 80H,20H
SJMP TASK3_LOOP


;FUNCTION FOR COLUMN CHECK
COLCHECK:
	SETB C
	ANL C,C0
	;JC CHECK1
	ANL C,C1
	;JC CHECK2
	ANL C,C2
	RET

	 
	

;FOR DELAY SUBROUTINE

	delay1ms:
	mov r7,#255
	djnz r7,$
	mov r7,#242
	djnz r7,$
	ret

delay100ms:
	mov r6,#99
l1:
	acall delay1ms
	djnz r6,l1
	mov r6,#255
	djnz r6,$
	mov r6,#142
	djnz r6,$
	nop
	ret
END